<!DOCTYPE html>
<html>
<head>
<title>CSV整形</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<style type="text/css">
#container {
    left: 35%;
    top: 35%;
    position: fixed;
    border: 1px grey dashed;
    padding: 50px;
    width: 400px;
    background: #f5f5ef;
}
#info {
	padding-top: 40px;
	text-align: center;
	display: none;
}
</style>
</head>
<body>
<!--http://www.bad-company.jp/box-shadow/-->
<div id="container">
	<div class="form-inline" action="">
		<div class="form-group">
			<div class="input-group">
				<input id="file" type="file" style="display:none;" />
				<input type="text" class="form-control" disabled id="fileName"/>
			</div>
		</div>
		<button type="submit" class="btn btn-default" for="file" display="fileName" id="selectFile">ファイル選択</button>
	</div>
	<div id="info">処理中(<span id="count">1000</span>/<span id="sum">50000</span>件)</div>
</div>

<!-- <div style="height: 400px; overflow-y: scroll;">
	<table id="result">
		<tr><th>変換前</th><th>変換後</th><th>抽出</th></tr>
	</table>
</div> -->

<script type="text/javascript">

String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.replace(new RegExp(search, 'g'), replacement);
};

const ReplaceMap = [
	{ from: '【', 	to: '(' 	},
	{ from: '】', 	to: ')' 	},
	{ from: '元年', 	to: '1年'	},
	{ from: '年年',	to: '年'		},
	{ from: ' |　|､|、|"|,|．|\\.|\\n',	to: '' }, // 半角スペース,全角スペース,「"」,「、」,「改行コード」は削除、
	{ from: '(株)',	to: '株式会社' },
	// 金額
	{ from: '壱',	to: 1		},
	{ from: '弐',	to: 2		},
	{ from: '参',	to: 3		},
	{ from: '肆',	to: 4		},
	{ from: '伍',	to: 5		},
	{ from: '陸',	to: 6		},
	{ from: '漆|質',	to: 7		},
	{ from: '捌',	to: 8		},
	{ from: '玖',	to: 9		},
	{ from: '陌|佰',	to: '百'		},
	{ from: '阡|仟',	to: '千'		},
	{ from: '萬', 	to: '万'		}
];

/**
 * 全角から半角への変革関数
 */
function toHalfWidth(strVal) {
	// 半角変換
	var replaced = strVal.replace(/[！-～]/g, function(tmpStr) {
    	// 文字コードをシフト
    	return String.fromCharCode(tmpStr.charCodeAt(0) - 0xFEE0);
    });

	// 特殊文字列変換
  	$.each(ReplaceMap, function(index, element) {
  		replaced = replaced.replace(new RegExp(element.from, 'g'), element.to);
	});

	return replaced;
}

function moveBracketBack(str) {
	var replaced = str;
	// ()付の情報は後ろに移動する
	var bracket = new RegExp('\\([^\\(]*\\)', 'g');
	var matched = replaced.match(bracket);
	if (replaced.match(bracket) != null) {
		replaced = replaced.replace(bracket, '|');
		replaced += matched.join('');
	}
	return replaced;
}

const YearMap = [
	{ from: '平成|H|h', 	to: 1988 },
	{ from: '昭和|S|s', 	to: 1925 },
	{ from: '大正|T|t', 	to: 1911 },
	{ from: '明治|M|m', 	to: 1867 }
];

const Type = {
	Date: 		'日付',
	Money: 		'金額',
	Phone: 		'電話番号',
	PeopleNum: 	'人数',
	CmpName: 	'会社名',
	EngCmpName: '英文社名',
	PostCode: 	'郵便番号',
	Location: 	'所在地' 
};

const AmountUnit = [
	{ unit: '億',	amount: 100000000 	},
	{ unit: '千万',	amount: 10000000	},
	{ unit: '百万', 	amount: 1000000		},
	{ unit: '万',	amount: 10000		},
	{ unit: '千', 	amount: 1000		},
	{ unit: '百', 	amount: 100			},
	{ unit: '十',	amount: 10			},
	{ unit: '円',	amount: 1			},
	{ unit: '',		amount: 1			}
];

/**
 * 和暦→西歴へ変換処理
 */
function yearReplacer(match, p1, p2, p3, offset, string) {
	var replaced;
	$.each(YearMap, function(index, element) {
		if(element.from.indexOf(match.match(/[^\d年]+/g).join('')) > -1)  {
			let jpYear = parseInt(match.match(/[\d]+/g).join(''));
			let adYear = parseInt(jpYear + element.to);
			// console.log("match=" + match + ",to=" + adYear + "年");
			replaced = adYear + "年";
			return false;
		}
	});
	return replaced;
}

/**
 * 和暦→西歴へ変換
 */
function toJpYear(str) {
	return str.replace(/(昭和|平成|明治|大正|s|h|m|t)\d+年/gi, yearReplacer);
}

function handleFileSelect() {

	// inputタグからFileオブジェクトを取得
    var file = $("#file"); 
    // ファイル読み取り用オブジェクト作成
    var reader = new FileReader(); 
    // ファイル読み込み
    reader.readAsText(file[0].files[0]);
    // 処理開始
    $('#info').show();
    processing();

    // 全角→半角
    // 昭和|大正|明治年号変換  (/(昭和|平成|明治|大正)\d+年/g)
    var loaded = function(event) {
    	// 1行ごとに分割
    	var arr = event.target.result.split('\r\n');
    	arr.pop(); 
    	var resultArr = new Array();
		// console.log(arr.length);
		var count = 0;

		var patternAry = new Array();

    	$.each(arr, function(index, element) {

    		count++;
    		// if (count < 27764) { return true; }
    		// if (count > 32763) { return false; }

    		var num = element.split(',')[0];
    		console.log("element=" + element);
    		var type = element.split(',')[1].replace(/\"/g, '');
    		var tempAry = element.split(',');
    		tempAry.splice(0, 2);
    		var content = tempAry.join(',');
			content = toHalfWidth(content);

    		// TODO 後ろに移動可能
    		content = toJpYear(content);

    		arr[index] = content;

    		// 電話番号の整形
    		if (type == Type.Phone) {
    			// 不要な文字削除
    			// content = content.replace(new RegExp('‐|−|-|ー|,|\\.|\\(|\\)', 'g'), '');
    			content = content.replace(new RegExp('‐|−|-|ー|ｰ|,|\\.|\\(|\\)', 'g'), '-');
	    			// if (content.length > 11 || content.length < 10) {
	    			// 	console.log("element=" + element + ",type=" + type);
	    			// 	return true;
	    			// }
    			// var replacedPhoneStr = '';
    			// if (content.length == 10) {
    			// 	replacedPhoneStr = content.substr(0, 2) + '-' + content.substr(2, 4) + '-'
    			// 		+ content.substr(6, 4);
    			// } else if (content.length == 11) {
    			// 	replacedPhoneStr = content.substr(0, 3) + '-' + content.substr(3, 4) + '-'
    			// 		+ content.substr(7, 4);
    			// }
    			resultArr.push(num + ',' + Type.Phone + ',' + content);
    			return true;
    		}

    		// 郵便番号の整形
    		if (type == Type.PostCode) {
    			resultArr.push(num + ',' + Type.PostCode + ',' + content);
    			return true;
    		}

    		// console.log("elemnt=" + element + "type=" + type);

    		if (type == Type.Date || type == Type.Money || type == Type.PeopleNum) {
    			content = moveBracketBack(content);
    		}

    		var matched = '';
    		var dateReplacer = function(match, p1, p2, p3, offset, string) {

    			resultArr.push(num + ',日付,' + match.match(/\d+/g).join('-'));
				// console.log(num + ',日付,' + match);
				matched += match + '<日付>';
				return '';
    		};

    		// 日付の整形
    		content = content.replace(/\d{4}年\d+月\d+日|\d+年\d+月|\d+年/g, dateReplacer);

    		// var matched = content.match(/\d+年\d+月\d+日|\d+年\d+月|\d+年/g);
    		// if(matched != null) { 
    		// 	$.each(matched, function(i, e) {
    		// 		resultArr.push(num + ',日付,' + e);
    		// 		console.log(num + ',日付,' + e);
    		// 	});
    		// 	matched = matched.join('<日付>|') + '<日付>';
    		// 	// 抽出済みの内容は削除する　TODO 問題あり
    		// 	content.replace
    		// }

    		if (type == Type.Money) {
	    		// 金額の整形 (億|千万|百万|万)*/g)
	    		matched = content.match(/(\d)+(億|万|千|百|円)*[^\d億万千百円]*/g);
	    		if(matched != null) {
	    			$.each(matched, function(i, e) {

	    				// 単位以外のものを削除する
	    				e = e.replace(/[^\d億万千百]/g, '');
	    				var sumAmount = 0;
	    				var matchUnit = e.match(/(\d)+(億|万|千|百|円)*/g);
	    				if (matchUnit != null) {
	    					$.each(matchUnit, function(unIndex, unElement) {

			    				var unit = unElement.match(/[^\d]/g);
			    				unit = (unit == null) ? '' : unit.join('');
				    			var amount = unElement.match(/\d/g).join('');
				    			$.each(AmountUnit, function(auIndex, auElement) {

				    				if (unit.indexOf(auElement.unit) > -1) {
				    					sumAmount += amount * auElement.amount;
				    					return false;
				    				}
				    			});
	    					});
			    		}
		    			resultArr.push(num + ',金額,' + sumAmount);
						// console.log("element=" + element + "→" + num + ',' + sumAmount);
	    			});
	    		}
			}

			if (type == Type.PeopleNum) {
				// TODO replace追加
				// content = content.replace(/(\d)+:(\d)+|(\d)+級|(\d)+%/g, '');
				matched = content.match(/(\d)+(人|名)+/g);

				// var pattern = content.match(/(\d)+[^\d]/g);
				// if (pattern != null) {
				// 	$.each(pattern, function(i, e){
				// 		var sPattern = e.match(/[^\d]/g);
				// 		if (patternAry.join(',').indexOf(sPattern.join('')) < 0) {
				// 			patternAry.push(sPattern.join(''));
				// 		}
				// 	});
				// }

				if (matched != null) {
					$.each(matched, function(i, e) {

						var peopleNum = e.match(/(\d)+/g);
						resultArr.push(num + ',人数,' + peopleNum.join(''));
						// console.log("elemnt=" + element + "----->" + num + "," + peopleNum);
					});
				}
			}

    		// addProcessInfo(element, content, matched);
    		// console.log(content);
    	});

    	// ファイル保存
    	end();
    	downloadCsvFile(resultArr.join('\r\n'), 'result.csv');
    }

    // ファイルを読み込み処理
    reader.onload = loaded;
}

$('#start').on('click', function(event) {
	handleFileSelect(event);
});

var clearFun;

var times = 0;
var clear = function() {
	$('#info').html('処理中...');
	clearInterval(clearFun);
}

var processing = function() {
	$('#info').html('処理中');
	clearFun = setInterval(clear, 1000);
}

var end = function() {
	clearInterval(clearFun);
	$('#info').html('処理完了');
}

/**
 *　jsonデータからCSVファイルに変換し、ダウンロードを行う
 */
var downloadCsvFile = function(data, fileName) {

    var downloadData = new Blob([data], {type: 'text/csv'});
    var downloadUrl  = (window.URL || window.webkitURL).createObjectURL(downloadData);
    var link = document.createElement('a');
    link.href = downloadUrl;
    link.download = fileName;
    link.click();
    (window.URL || window.webkitURL).revokeObjectURL(downloadUrl);
};

function addProcessInfo(from, to, target) {
	$("#result").append('<tr><td>' + from + '</td><td>' + 
		to + '</td><td>' + target + '</td></tr>');
}

var initFileInput = function(target) {

    $.each(target, function(index, element) {
        
        var fileInput = $("#" + $(this).attr("for"));
        var fileNameInput = $("#" + $(this).attr("display"));

        $(this).on('click', function() {
            $(fileInput).click();           
        });

        $(fileInput).change(function() {
            $(fileNameInput).val($(this).val());      
            handleFileSelect();      
        });
    });
};

initFileInput($('#selectFile'));

</script>

</script>
</body>
</html>