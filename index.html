<!DOCTYPE html>
<html>
<head>
<title>CSV整形</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="dataExtraction.js"></script>
<style type="text/css">
#container {
    left: 35%;
    top: 35%;
    position: fixed;
    border: 1px grey dashed;
    padding: 50px;
    width: 450px;
    background: #f5f5ef;
}
#info {
	padding-top: 40px;
	text-align: center;
	display: none;
}
</style>
</head>
<body>
<div id="container">
	<div class="form-inline" action="">
		<div class="form-group">
			<div class="input-group">
				<input id="file" type="file" style="display:none;" />
				<input type="text" class="form-control" disabled id="fileName"/>
			</div>
		</div>
		<button type="submit" class="btn btn-default" for="file" display="fileName" id="selectFile">ファイル選択</button>
	</div>
	<div id="info"></div>
</div>

<script type="text/javascript">

function handleFileSelect() {

	// inputタグからFileオブジェクトを取得
    var file = $("#file"); 
    // ファイル読み取り用オブジェクト作成
    var reader = new FileReader(); 
    // ファイル読み込み
    reader.readAsText(file[0].files[0]);
    // 処理開始
    $('#info').show();
    processing();

    // 全角→半角
    // 昭和|大正|明治年号変換  (/(昭和|平成|明治|大正)\d+年/g)
    var loaded = function(event) {
    	
    	// CSVファイルからデータ読み込み
    	var arr = event.target.result.split('\r\n');
    	// 最後の１行を削除
    	arr.pop();

    	var input = new Array();
    	$.each(arr, function(index, element) {
			var tempAry = element.split(',');
			tempAry.splice(0, 2);
    		var dataElement = {
    			no: 		element.split(',')[0],
    			type: 		element.split(',')[1].replace(/\"/g, ''),
    			content: 	tempAry.join(',')
    		};
    		input.push(dataElement);
    	});

    	// 整形処理を行う
    	var resultArr = dataExtraction(input);

    	var csvArr = new Array();
    	$.each(resultArr, function(i, e){
    		csvArr.push(e.no + ',"' + e.type + '","' + e.content + '"')
    	});
    	// CSVファイルに保存
    	end();
    	downloadCsvFile(csvArr.join('\r\n'), 'result.csv');
    }

    // ファイルを読み込み処理
    reader.onload = loaded;
}

$('#start').on('click', function(event) {
	handleFileSelect(event);
});

var clearFun;
var counter = 0;
var showProcessing = function() {
	counter++;
	$('#info').html('処理中' + new Array(counter % 4).fill('.').join(''));
}

var processing = function() {
	$('#info').html('処理中');
	clearFun = setInterval(showProcessing, 1000);
}

var end = function() {
	clearInterval(clearFun);
	$('#info').html('処理完了');
}

/**
 *　jsonデータからCSVファイルに変換し、ダウンロードを行う
 */
var downloadCsvFile = function(data, fileName) {

    var downloadData = new Blob([data], {type: 'text/csv'});
    var downloadUrl  = (window.URL || window.webkitURL).createObjectURL(downloadData);
    var link = document.createElement('a');
    link.href = downloadUrl;
    link.download = fileName;
    link.click();
    (window.URL || window.webkitURL).revokeObjectURL(downloadUrl);
};

function addProcessInfo(from, to, target) {
	$("#result").append('<tr><td>' + from + '</td><td>' + 
		to + '</td><td>' + target + '</td></tr>');
}

var initFileInput = function(target) {

    $.each(target, function(index, element) {
        
        var fileInput = $("#" + $(this).attr("for"));
        var fileNameInput = $("#" + $(this).attr("display"));

        $(this).on('click', function() {
            $(fileInput).click();           
        });

        $(fileInput).change(function() {
            $(fileNameInput).val($(this).val());      
            handleFileSelect();      
        });
    });
};

initFileInput($('#selectFile'));

</script>

</script>
</body>
</html>